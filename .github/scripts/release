#!/bin/bash -eux

v=$(head -n1 src/version)
releases=/repos/maddenp/nml/releases

# Create the release.

curl https://api.github.com/$releases      \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer $GH_TOKEN"     \
  -H "X-GitHub-Api-Version: 2022-11-28"    \
  -X POST                                  \
  -d "{\"tag_name\":\"$v\"}" | tee create.json

# Upload the asset(s).

id=$(jq -r .id create.json)

curl https://uploads.github.com/$releases/$id/assets?name=nml.jar \
  --data-binary "@target/nml.jar"                                 \
  -H "Accept: application/vnd.github+json"                        \
  -H "Authorization: Bearer $GH_TOKEN"                            \
  -H "Content-Type: application/octet-stream"                     \
  -H "X-GitHub-Api-Version: 2022-11-28"                           \
  -X POST | tee upload.json
